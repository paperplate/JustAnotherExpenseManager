{% if transactions %}
{# Group transactions by month #}
{% set months = {} %}
{% for trans in transactions %}
    {% set month_key = trans.date[:7] %}  {# Extract YYYY-MM #}
    {% if month_key not in months %}
        {% set _ = months.update({month_key: []}) %}
    {% endif %}
    {% set _ = months[month_key].append(trans) %}
{% endfor %}

{# Display transactions grouped by month #}
{% for month in months.keys()|sort(reverse=True) %}
<div style="margin-bottom: 30px;">
    <h3 style="color: #333; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0;">
        {{ month|replace('-', ' ')|title }}
    </h3>

    <table class="transactions-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Description</th>
                <th>Type</th>
                <th>Category & Tags</th>
                <th>Amount</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for trans in months[month] %}
            <tr>
                <td>{{ trans.date }}</td>
                <td>{{ trans.description }}</td>
                <td>
                    {# Use .value to get string from enum #}
                    <span class="type-badge type-{{ trans.type.value }}">
                        {{ trans.type.value|capitalize }}
                    </span>
                </td>
                <td>
                    {% for tag in trans.tags %}
                        {% if tag.is_category %}
                            <span class="tag-badge category-tag">
                                {{ tag.category_name|capitalize }}
                            </span>
                        {% else %}
                            <span class="tag-badge">
                                {{ tag.name }}
                            </span>
                        {% endif %}
                    {% endfor %}
                </td>
                <td class="amount amount-{{ trans.type.value }}">
                    {# Use is_income property and amount_dollars #}
                    {% if trans.is_income %}+{% else %}-{% endif %}${{ "%.2f"|format(trans.amount_dollars) }}
                </td>
                <td>
                    <button class="btn btn-edit btn-small"
                            data-transaction-id="{{ trans.id }}"
                            data-description="{{ trans.description|escape }}"
                            data-amount="{{ trans.amount_dollars }}"
                            data-type="{{ trans.type.value }}"
                            data-date="{{ trans.date }}"
                            data-category="{{ trans.category or '' }}"
                            data-tags="{{ trans.non_category_tags|join(',') }}"
                            onclick="editTransaction(this)">
                        Edit
                    </button>
                    <button class="btn btn-delete"
                            hx-delete="/api/transactions/{{ trans.id }}"
                            hx-target="#transactions-list"
                            hx-swap="innerHTML"
                            hx-confirm="Are you sure you want to delete this transaction?"
                            hx-on::after-request="htmx.trigger('body', 'refreshStats')">
                        Delete
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {# Monthly summary - calculate manually since we can't use selectattr with enums #}
    {% set month_income = 0 %}
    {% set month_expense = 0 %}
    {% for trans in months[month] %}
        {% if trans.is_income %}
            {% set month_income = month_income + trans.amount_dollars %}
        {% else %}
            {% set month_expense = month_expense + trans.amount_dollars %}
        {% endif %}
    {% endfor %}
    <div style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 6px; display: flex; gap: 20px; font-size: 14px;">
        <div style="color: #00b894;">
            <strong>Income:</strong> ${{ "%.2f"|format(month_income) }}
        </div>
        <div style="color: #d63031;">
            <strong>Expenses:</strong> ${{ "%.2f"|format(month_expense) }}
        </div>
        <div style="color: #333;">
            <strong>Net:</strong> ${{ "%.2f"|format(month_income - month_expense) }}
        </div>
        <div style="color: #666; margin-left: auto;">
            <strong>Transactions:</strong> {{ months[month]|length }}
        </div>
    </div>
</div>
{% endfor %}

<!-- Pagination -->
{% if pagination.total_pages > 1 %}
<div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px;">
    {% if pagination.page > 1 %}
        <button class="btn"
                hx-get="/api/transactions?page={{ pagination.page - 1 }}"
                hx-target="#transactions-list"
                hx-swap="innerHTML">
            ‚Üê Previous
        </button>
    {% endif %}

    <span style="color: #666; font-weight: 600;">
        Page {{ pagination.page }} of {{ pagination.total_pages }}
    </span>

    {% if pagination.page < pagination.total_pages %}
        <button class="btn"
                hx-get="/api/transactions?page={{ pagination.page + 1 }}"
                hx-target="#transactions-list"
                hx-swap="innerHTML">
            Next ‚Üí
        </button>
    {% endif %}
</div>
<div style="text-align: center; margin-top: 10px; color: #666;">
    Total: {{ pagination.total }} transactions
</div>
{% endif %}

{% else %}
<div class="empty-state">
    <p style="font-size: 3rem;">üìù</p>
    <p>No transactions yet. Add your first transaction above or load test data from Settings!</p>
</div>
{% endif %}
