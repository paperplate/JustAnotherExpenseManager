{% extends "base.html" %}

{% block title %}Summary - Expense Manager{% endblock %}

{% block extra_styles %}
<style>
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .summary-card.income {
        background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
    }
    
    .summary-card.expense {
        background: linear-gradient(135deg, #d63031 0%, #ff7675 100%);
    }
    
    .summary-card.net {
        background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
    }
    
    .summary-label {
        font-size: 1rem;
        opacity: 0.9;
        margin-bottom: 10px;
    }
    
    .summary-value {
        font-size: 2.5rem;
        font-weight: 700;
    }
    
    .filter-section {
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .filter-section label {
        font-weight: 600;
        color: #333;
    }
    
    .filter-section select {
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 16px;
        min-width: 200px;
        transition: border-color 0.3s;
    }
    
    .filter-section select:focus {
        outline: none;
        border-color: #667eea;
    }
    
    .charts-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
    }
    
    .chart-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .chart-card h3 {
        color: #333;
        margin-bottom: 15px;
        font-size: 1.3rem;
    }
    
    @media (max-width: 768px) {
        .charts-container {
            grid-template-columns: 1fr;
        }
        
        .summary-value {
            font-size: 2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h1 style="color: #333; margin-bottom: 20px;">Financial Summary</h1>
    
    <div class="filter-section">
        <div>
            <label for="time-range">Time Range:</label>
            <select id="time-range" onchange="filterByTimeRange(this.value)">
                <option value="">All Time</option>
                <option value="current_month">Current Month</option>
                <option value="3_months">Last 3 Months</option>
                <option value="6_months" selected>Last 6 Months</option>
                <option value="1_year">Last Year</option>
                <option value="custom">Custom Range...</option>
            </select>
        </div>
        <div>
            <label for="category-filter">Filter by Category:</label>
            <select id="category-filter" onchange="filterByCategory(this.value)">
                <option value="">All Categories</option>
            </select>
        </div>
    </div>
    
    <!-- Custom date range picker (hidden by default) -->
    <div id="custom-range-picker" style="display: none; margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 6px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end;">
            <div>
                <label for="start-date">Start Date:</label>
                <input type="date" id="start-date" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
            </div>
            <div>
                <label for="end-date">End Date:</label>
                <input type="date" id="end-date" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
            </div>
            <button class="btn" onclick="applyCustomRange()">Apply</button>
        </div>
    </div>
</div>

<div id="stats-container" 
     hx-get="/api/stats" 
     hx-trigger="load, refreshStats from:body"
     hx-swap="innerHTML">
    <div class="card">Loading statistics...</div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Load categories for filter
    async function loadCategories() {
        try {
            const response = await fetch('/api/categories');
            const categories = await response.json();
            
            const select = document.getElementById('category-filter');
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = cat.name.charAt(0).toUpperCase() + cat.name.slice(1);
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }
    
    function filterByCategory(category) {
        const timeRange = document.getElementById('time-range').value;
        applyFilters(category, timeRange);
    }
    
    function filterByTimeRange(range) {
        const customPicker = document.getElementById('custom-range-picker');
        
        if (range === 'custom') {
            customPicker.style.display = 'block';
            return;
        } else {
            customPicker.style.display = 'none';
        }
        
        const category = document.getElementById('category-filter').value;
        applyFilters(category, range);
    }
    
    function applyCustomRange() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        if (!startDate || !endDate) {
            alert('Please select both start and end dates');
            return;
        }
        
        const category = document.getElementById('category-filter').value;
        applyFilters(category, 'custom', startDate, endDate);
    }
    
    function applyFilters(category, range, startDate, endDate) {
        let url = '/api/stats';
        const params = [];
        
        if (category) params.push(`category=${category}`);
        if (range && range !== 'custom') params.push(`range=${range}`);
        if (startDate) params.push(`start_date=${startDate}`);
        if (endDate) params.push(`end_date=${endDate}`);
        
        if (params.length > 0) {
            url += '?' + params.join('&');
        }
        
        htmx.ajax('GET', url, {target: '#stats-container', swap: 'innerHTML'});
    }
    
    // Load categories on page load
    loadCategories();
</script>
{% endblock %}
