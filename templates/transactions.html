{% extends "base.html" %}

{% block title %}Transactions - Expense Manager{% endblock %}

{% block content %}
<!-- Add Transaction Form -->
<div class="card">
    <h2 style="margin-bottom: 20px; color: #333;">Add Transaction</h2>
    <form hx-post="/api/transactions" 
          hx-target="#transactions-list" 
          hx-swap="innerHTML"
          hx-on::after-request="this.reset(); htmx.trigger('body', 'refreshStats')">
        <div class="form-row">
            <div class="form-group">
                <label for="description">Description</label>
                <input type="text" id="description" name="description" required placeholder="e.g., Grocery shopping">
            </div>
            <div class="form-group">
                <label for="amount">Amount ($)</label>
                <input type="number" id="amount" name="amount" step="0.01" required placeholder="0.00">
            </div>
            <div class="form-group">
                <label for="type">Type</label>
                <select id="type" name="type" required>
                    <option value="expense">Expense</option>
                    <option value="income">Income</option>
                </select>
            </div>
            <div class="form-group">
                <label for="date">Date</label>
                <input type="date" id="date" name="date" required>
            </div>
        </div>
        <div class="form-row-full">
            <div class="form-group">
                <label for="category">Category</label>
                <select id="category" name="category" required>
                    <option value="">Select category...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="tags">Tags (comma-separated, optional)</label>
                <input type="text" id="tags" name="tags" placeholder="recurring, urgent, planned">
            </div>
        </div>
        <button type="submit" class="btn">Add Transaction</button>
    </form>
</div>

<!-- Import from CSV -->
<div class="card">
    <h2 style="margin-bottom: 20px; color: #333;">Import from CSV</h2>
    <p style="margin-bottom: 15px; color: #666;">
        CSV format: description, amount, type, category, date, tags (optional)
    </p>
    <form id="import-form" enctype="multipart/form-data">
        <div style="display: flex; gap: 15px; align-items: end;">
            <div class="form-group" style="flex: 1; margin-bottom: 0;">
                <label for="csv_file">CSV File</label>
                <input type="file" id="csv_file" name="csv_file" accept=".csv" required>
            </div>
            <button type="submit" class="btn">Import CSV</button>
        </div>
    </form>
    <div id="import-result" style="margin-top: 15px;"></div>
</div>

<!-- Transactions List -->
<div class="card">
    <h2 style="margin-bottom: 20px; color: #333;">Transactions</h2>
    <div id="transactions-list" 
         hx-get="/api/transactions" 
         hx-trigger="load"
         hx-swap="innerHTML">
        <div class="empty-state">Loading transactions...</div>
    </div>
</div>

<!-- Edit Transaction Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit Transaction</h2>
            <span class="close" onclick="closeEditModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <div class="form-group">
                    <label for="edit-description">Description</label>
                    <input type="text" id="edit-description" name="description" required>
                </div>
                <div class="form-group">
                    <label for="edit-amount">Amount ($)</label>
                    <input type="number" id="edit-amount" name="amount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="edit-type">Type</label>
                    <select id="edit-type" name="type" required>
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-date">Date</label>
                    <input type="date" id="edit-date" name="date" required>
                </div>
                <div class="form-group">
                    <label for="edit-category">Category</label>
                    <select id="edit-category" name="category" required>
                        <option value="">Select category...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-tags">Tags (comma-separated)</label>
                    <input type="text" id="edit-tags" name="tags">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-cancel" onclick="closeEditModal()">Cancel</button>
            <button class="btn" onclick="saveEditTransaction()">Save Changes</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Set today's date as default
    document.getElementById('date').valueAsDate = new Date();
    
    // Load categories
    async function loadCategories() {
        try {
            const response = await fetch('/api/categories');
            const categories = await response.json();
            
            const select = document.getElementById('category');
            select.innerHTML = '<option value="">Select category...</option>';
            
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = cat.name.charAt(0).toUpperCase() + cat.name.slice(1);
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }
    
    // Handle CSV import
    document.getElementById('import-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const resultDiv = document.getElementById('import-result');
        
        resultDiv.innerHTML = '<p style="color: #666;">⏳ Importing...</p>';
        
        try {
            const response = await fetch('/api/transactions/import', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                let message = `<p style="color: #00b894; font-weight: 600;">✓ Successfully imported ${result.imported} transaction(s)!</p>`;
                
                if (result.errors && result.errors.length > 0) {
                    message += `<p style="color: #e17055; margin-top: 10px;">⚠️ ${result.errors.length} error(s):</p>`;
                    message += '<ul style="margin-left: 20px; color: #e17055;">';
                    result.errors.forEach(error => {
                        message += `<li>${error}</li>`;
                    });
                    message += '</ul>';
                }
                
                resultDiv.innerHTML = message;
                
                // Refresh transactions list and stats
                htmx.trigger('#transactions-list', 'load');
                htmx.trigger('body', 'refreshStats');
                
                // Reset form
                e.target.reset();
            } else {
                resultDiv.innerHTML = `<p style="color: #d63031;">❌ ${result.error}</p>`;
            }
        } catch (error) {
            resultDiv.innerHTML = `<p style="color: #d63031;">❌ Error: ${error.message}</p>`;
        }
    });
    
    // Load categories on page load
    loadCategories();
    
    // Edit transaction functions
    async function editTransaction(id, description, amount, type, date, category, tags) {
        // Load categories in modal
        try {
            const response = await fetch('/api/categories');
            const categories = await response.json();
            
            const select = document.getElementById('edit-category');
            select.innerHTML = '<option value="">Select category...</option>';
            
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = cat.name.charAt(0).toUpperCase() + cat.name.slice(1);
                if (cat.name === category) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading categories:', error);
        }
        
        // Populate form
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-description').value = description;
        document.getElementById('edit-amount').value = amount;
        document.getElementById('edit-type').value = type;
        document.getElementById('edit-date').value = date;
        
        // Handle tags - remove category tags
        const tagArray = tags.split(',').filter(t => t && !t.startsWith('category:'));
        document.getElementById('edit-tags').value = tagArray.join(', ');
        
        // Show modal
        document.getElementById('editModal').style.display = 'block';
    }
    
    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }
    
    async function saveEditTransaction() {
        const id = document.getElementById('edit-id').value;
        const formData = new FormData();
        formData.append('description', document.getElementById('edit-description').value);
        formData.append('amount', document.getElementById('edit-amount').value);
        formData.append('type', document.getElementById('edit-type').value);
        formData.append('date', document.getElementById('edit-date').value);
        formData.append('category', document.getElementById('edit-category').value);
        formData.append('tags', document.getElementById('edit-tags').value);
        
        try {
            const response = await fetch(`/api/transactions/${id}`, {
                method: 'PUT',
                body: formData
            });
            
            if (response.ok) {
                closeEditModal();
                // Refresh transactions list
                htmx.trigger('#transactions-list', 'load');
                htmx.trigger('body', 'refreshStats');
            } else {
                alert('Failed to update transaction');
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    // Make functions globally available
    window.editTransaction = editTransaction;
    window.closeEditModal = closeEditModal;
    window.saveEditTransaction = saveEditTransaction;
</script>
{% endblock %}
